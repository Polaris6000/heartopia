<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>ë¬¼ê³ ê¸° ì°¾ê¸° - ë‘ê·¼ë‘ê·¼íƒ€ìš´</title>
    <link href="../../css/common.css" rel="stylesheet">
</head>
<body>
<div id="header-placeholder"></div>

<main>
    <div class="datetime-section">
        <nav>
            <ul>
                <li><a href="fish_list.html">ì–´ë¥˜ ë„ê°</a></li>
            </ul>
        </nav>
        <h1>ğŸ” ë¬¼ê³ ê¸° ì°¾ê¸°</h1>
        <p>í˜„ì¬ ì¡°ê±´ì—ì„œ ì¡ì„ ìˆ˜ ìˆëŠ” ë¬¼ê³ ê¸°ë¥¼ ì°¾ì•„ë³´ì„¸ìš”</p>

        <div class="datetime-display">
            <div class="date-info">
                <div class="current-date" id="currentDate"></div>
                <div class="current-time" id="currentTime"></div>
            </div>
        </div>
        <div class="time-bar">
            <div class="time-segment morning">
                <div class="segment-label">ğŸŒ… ì•„ì¹¨</div>
                <div class="segment-time">06:00 - 12:00</div>
            </div>
            <div class="time-segment afternoon">
                <div class="segment-label">â˜€ï¸ ë‚®</div>
                <div class="segment-time">12:00 - 18:00</div>
            </div>
            <div class="time-segment evening">
                <div class="segment-label">ğŸŒ† ì €ë…</div>
                <div class="segment-time">18:00 - 00:00</div>
            </div>
            <div class="time-segment night">
                <div class="segment-label">ğŸŒ™ ìƒˆë²½</div>
                <div class="segment-time">00:00 - 06:00</div>
            </div></div>
        </div>
    </div>

    <div class="input-section">
        <div class="input-group">
            <div class="input-item">
                <label for="fishName">ğŸŸ ë¬¼ê³ ê¸° ì´ë¦„</label>
                <input id="fishName" oninput="filterFish()" placeholder="ì˜ˆ: ì—°ì–´, ë°°ìŠ¤, ë¶•ì–´..." type="text">
            </div>

            <div class="input-item">
                <label for="level">ğŸ£ ì·¨ë¯¸ ë ˆë²¨</label>
                <input id="level" max="20" min="1" type="number" value="7">
            </div>

            <div class="input-item">
                <label for="time">ğŸ• ì‹œê°„ëŒ€</label>
                <select id="time">
                    <option value="ì•„ì¹¨">ì•„ì¹¨</option>
                    <option value="ë‚®">ë‚®</option>
                    <option value="ì €ë…">ì €ë…</option>
                    <option value="ìƒˆë²½">ìƒˆë²½</option>
                </select>
            </div>

            <div class="input-item">
                <label for="weather">ğŸŒ¤ï¸ ë‚ ì”¨</label>
                <select id="weather">
                    <option selected value="ë§‘ìŒ">ë§‘ìŒ</option>
                    <option value="ë¹„">ë¹„</option>
                    <option value="ë¬´ì§€ê°œ">ë¬´ì§€ê°œ</option>
                </select>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
            <button onclick="filterFish()">ğŸ” ë¬¼ê³ ê¸° ì°¾ê¸°</button>
            <button class="filter-btn winter-season-btn" onclick="loadSeasonData('winter_fish.json')">â„ï¸ ë¹™ì„¤ ì‹œì¦Œ ì¶”ê°€
            </button>
            <button class="filter-btn-reset winter-season-btn" onclick="removeSeasonData()">ğŸ—‘ï¸ ì‹œì¦Œ ë°ì´í„° ì œê±°</button>
        </div>
    </div>

    <div class="results" id="results"></div>
</main>

<div id="footer-placeholder"></div>

<script src="../../js/common.js"></script>
<script>
    let fishData = [];
    let currentSort = {column: 'price', order: 'desc'};
    let loadedSeasons = new Set();

    // ë“±ê¸‰ë³„ ê°€ê²© ë°°ìœ¨
    const starMultipliers = {
        1: 1,
        2: 1.5,
        3: 2,
        4: 4,
        5: 8
    };

    function updateDateTime() {
        const now = new Date();
        const days = ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const date = String(now.getDate()).padStart(2, '0');
        const dayName = days[now.getDay()];
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');

        document.getElementById('currentDate').textContent =
            `${year}ë…„ ${month}ì›” ${date}ì¼ ${dayName}`;
        document.getElementById('currentTime').textContent =
            `${hours}:${minutes}:${seconds}`;

        // í˜„ì¬ ì‹œê°„ëŒ€ ê³„ì‚° ë° í™œì„±í™”
        const hour = now.getHours();
        let currentPeriod = '';
        let position = 0;

        if (hour >= 6 && hour < 12) {
            currentPeriod = 'morning';
            position = ((hour - 6) * 60 + now.getMinutes()) / 360;
            position = position * 25 + 12.5;
        } else if (hour >= 12 && hour < 18) {
            currentPeriod = 'afternoon';
            position = ((hour - 12) * 60 + now.getMinutes()) / 360;
            position = position * 25 + 37.5;
        } else if (hour >= 18 && hour < 24) {
            currentPeriod = 'evening';
            position = ((hour - 18) * 60 + now.getMinutes()) / 360;
            position = position * 25 + 62.5;
        } else {
            currentPeriod = 'night';
            position = (hour * 60 + now.getMinutes()) / 360;
            position = position * 25 + 87.5;
        }

        document.querySelectorAll('.time-segment').forEach(seg => {
            seg.classList.remove('active');
        });

        const activeSegment = document.querySelector(`.time-segment.${currentPeriod}`);
        if (activeSegment) {
            activeSegment.classList.add('active');
        }
    }

    // 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // í˜ì´ì§€ ë¡œë“œì‹œ í˜„ì¬ ì‹œê°„ì— ë§ì¶° select ë°•ìŠ¤ ì„¤ì •
    function setInitialTimeOption() {
        const hour = new Date().getHours();
        const timeSelect = document.getElementById('time');

        if (hour >= 6 && hour < 12) {
            timeSelect.value = 'ì•„ì¹¨';
        } else if (hour >= 12 && hour < 18) {
            timeSelect.value = 'ë‚®';
        } else if (hour >= 18 && hour < 24) {
            timeSelect.value = 'ì €ë…';
        } else {
            timeSelect.value = 'ìƒˆë²½';
        }
    }

    async function loadFishData() {
        try {
            let response = await fetch('../../data/fish_data.json');

            if (!response.ok) {
                response = await fetch('./fish_data.json');
            }

            if (!response.ok) {
                throw new Error('fish_data.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            fishData = await response.json();
            console.log('ë¬¼ê³ ê¸° ë°ì´í„° ë¡œë“œ ì„±ê³µ:', fishData.length + 'ì¢…');
            filterFish();
        } catch (error) {
            console.error('ë°ì´í„° ë¡œë“œ ì—ëŸ¬:', error);
            document.getElementById('results').innerHTML =
                `<div class="error">âŒ ë°ì´í„° íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
        }
    }

    async function loadSeasonData(filename) {
        if (loadedSeasons.has(filename)) {
            alert('ì´ë¯¸ ì¶”ê°€ëœ ì‹œì¦Œì…ë‹ˆë‹¤.');
            return;
        }

        try {
            let response = await fetch(`../../data/${filename}`);

            if (!response.ok) {
                response = await fetch(`./${filename}`);
            }

            if (!response.ok) {
                throw new Error(`${filename} íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            }

            const seasonData = await response.json();

            // ì´ë¦„ ê¸°ì¤€ ì¤‘ë³µ ì œê±°í•˜ë©° ë³‘í•©
            const combined = [...fishData, ...seasonData];
            fishData = combined.filter((fish, index, self) =>
                index === self.findIndex((f) => f.name === fish.name)
            );

            loadedSeasons.add(filename);

            alert(`${seasonData.length}ì¢…ì˜ ì‹œì¦Œ ë°ì´í„°ê°€ ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì´ ${fishData.length}ì¢…)`);
            filterFish();
        } catch (error) {
            console.error('ì‹œì¦Œ ë°ì´í„° ë¡œë“œ ì—ëŸ¬:', error);
            alert(`ì‹œì¦Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n${error.message}`);
        }
    }

    async function removeSeasonData() {
        if (loadedSeasons.size === 0) {
            alert('ì œê±°í•  ì‹œì¦Œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            let response = await fetch('../../data/fish_data.json');
            if (!response.ok) {
                response = await fetch('./fish_data.json');
            }

            if (!response.ok) {
                throw new Error('fish_data.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            fishData = await response.json();
            loadedSeasons.clear();

            alert('ëª¨ë“  ì‹œì¦Œ ë°ì´í„°ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.\nê¸°ë³¸ ë°ì´í„°ë§Œ í‘œì‹œë©ë‹ˆë‹¤.');
            filterFish();
        } catch (error) {
            console.error('ë°ì´í„° ì´ˆê¸°í™” ì—ëŸ¬:', error);
            alert('ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function filterFish() {
        if (fishData.length === 0) {
            document.getElementById('results').innerHTML = '<div class="loading">â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            return;
        }

        const fishName = document.getElementById('fishName').value.trim().toLowerCase();
        const level = parseInt(document.getElementById('level').value);
        const time = document.getElementById('time').value;
        const weather = document.getElementById('weather').value;

        const filtered = fishData.filter(fish => {
            if (fishName && !fish.name.toLowerCase().includes(fishName)) return false;
            if (fish.level > level) return false;
            const timeOk = fish.time && fish.time.includes(time);
            const weatherOk = fish.weather && fish.weather.includes(weather);
            return timeOk && weatherOk;
        });

        displayResults(filtered);
    }

    function sortFish(fishes, column, order) {
        return [...fishes].sort((a, b) => {
            let valueA, valueB;
            if (column === 'name' || column === 'habitat') {
                valueA = column === 'name' ? a.name : a.habitat;
                valueB = column === 'name' ? b.name : b.habitat;
                return order === 'asc' ? valueA.localeCompare(valueB, 'ko') : valueB.localeCompare(valueA, 'ko');
            } else if (column === 'level') {
                valueA = a.level;
                valueB = b.level;
            } else if (column === 'price') {
                valueA = a.price;
                valueB = b.price;
            }
            return order === 'asc' ? valueA - valueB : valueB - valueA;
        });
    }

    function handleSort(column) {
        if (currentSort.column === column) {
            currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.order = 'asc';
        }
        filterFish();
    }

    function updatePrice(fishName, basePrice, selectElement) {
        const star = parseInt(selectElement.value);
        const multiplier = starMultipliers[star];
        const calculatedPrice = Math.floor(basePrice * multiplier);

        const priceSpan = selectElement.parentElement.querySelector('.price');
        priceSpan.textContent = `â‚©${calculatedPrice}`;
    }

    function getSpecialIcon(special) {
        const icons = {
            'ë¹™ì„¤ ì‹œì¦Œ': 'â„ï¸',
            'ì§‘ì–´ê¸°': 'ğŸ’',
            'í™©ê¸ˆ': 'âœ¨',
        }
        return icons[special] || '';
    }

    function getHabitatIcon(habitat) {
        const icons = {
            'ëª¨ë“  ê°•': 'ğŸŒŠ',
            'ëª¨ë“  í˜¸ìˆ˜': 'ğŸï¸',
            'ëª¨ë“  ë°”ë‹¤': 'ğŸŒ…',
            'ë°”ë‹¤ë‚šì‹œ': 'âš“',
            'ì–¼ìŒ ê²°ì • ë¬¼ê³ ê¸° ì‚¬ê±´': 'â„ï¸',
        };
        return icons[habitat] || '';
    }

    function getSizeIcon(size) {
        const icons = {
            'í‘¸ë¥¸ìƒ‰': 'ğŸŸ',
            'í™©ê¸ˆ': 'âœ¨',
        }
        return icons[size] || '';
    }

    function displayResults(fishes) {
        const resultsDiv = document.getElementById('results');

        if (fishes.length === 0) {
            resultsDiv.innerHTML = '<div class="no-results">âš ï¸ í˜„ì¬ ì¡°ê±´ì—ì„œ ì¡ì„ ìˆ˜ ìˆëŠ” ë¬¼ê³ ê¸°ê°€ ì—†ì–´ìš”!</div>';
            return;
        }

        const sortedFishes = sortFish(fishes, currentSort.column, currentSort.order);

        let html = `
                <div class="habitat-group">
                    <div class="habitat-header">
                        <span>ê²€ìƒ‰ ê²°ê³¼</span>
                        <span class="count-badge">${sortedFishes.length} ì¢…</span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="sortable ${currentSort.column === 'name' ? 'sort-' + currentSort.order : ''}" onclick="handleSort('name')">ì´ë¦„</th>
                                    <th class="sortable col-habitat-fish ${currentSort.column === 'habitat' ? 'sort-' + currentSort.order : ''}" onclick="handleSort('habitat')">ì„œì‹ì§€</th>
                                    <th class="col-size">í¬ê¸°</th>
                                    <th class="sortable col-level ${currentSort.column === 'level' ? 'sort-' + currentSort.order : ''}" onclick="handleSort('level')">ë ˆë²¨</th>
                                    <th class="sortable ${currentSort.column === 'price' ? 'sort-' + currentSort.order : ''}" onclick="handleSort('price')">íŒë§¤ê°€ (ë“±ê¸‰ë³„)</th>
                                    <th>ì¶œí˜„ ì‹œê°„</th>
                                    <th>ë‚ ì”¨ ì¡°ê±´</th>
                                </tr>
                            </thead>
                            <tbody>`;

        sortedFishes.forEach(fish => {
            // --- ì‹œê°„ í‘œì‹œ ë¡œì§ ---
            const allTimes = ['ì•„ì¹¨', 'ë‚®', 'ì €ë…', 'ìƒˆë²½'];
            const isAlwaysTime = fish.timeAll || (fish.time && allTimes.every(t => fish.time.includes(t)));
            const timeDisplay = isAlwaysTime
                ? '<span class="time-badge always">í•˜ë£¨ ì¢…ì¼</span>'
                : fish.time.map(t => `<span class="time-badge">${t}</span>`).join(' ');

            // --- ë‚ ì”¨ í‘œì‹œ ë¡œì§ ---
            const allWeathers = ['ë§‘ìŒ', 'ë¹„', 'ë¬´ì§€ê°œ'];
            const isAlwaysWeather = fish.weatherAll || (fish.weather && allWeathers.every(w => fish.weather.includes(w)));
            const weatherDisplay = isAlwaysWeather
                ? '<span class="weather-badge always">í•­ìƒ</span>'
                : fish.weather.map(w => `<span class="weather-badge">${w}</span>`).join(' ');

            const sizeDisplay = fish.size || '-';

            html += `
                    <tr>
                        <td class="item-name">${getSpecialIcon(fish.special)}${fish.name}</td>
                        <td>${getHabitatIcon(fish.habitat)}${fish.habitat}</td>
                        <td>${getSizeIcon(fish.size)}${sizeDisplay}</td>
                        <td><span class="level-badge">Lv.${fish.level}</span></td>
                        <td>
                            <div class="price-cell">
                                <span>â­</span>
                                <select class="star-selector" onchange="updatePrice('${fish.name}', ${fish.price}, this)">
                                    <option value="1">1ì„±</option>
                                    <option value="2">2ì„±</option>
                                    <option value="3">3ì„±</option>
                                    <option value="4">4ì„±</option>
                                    <option value="5">5ì„±</option>
                                </select>
                                <span class="price">â‚©${fish.price}</span>
                            </div>
                        </td>
                        <td>${timeDisplay}</td>
                        <td>${weatherDisplay}</td>
                    </tr>`;
        });

        html += `</tbody></table></div></div>`;
        resultsDiv.innerHTML = html;
    }

    // ì‹œê°„ ì„ íƒì„ ë¨¼ì € í•˜ê³  ë°ì´í„°ë¥¼ ë¡œë“œí•˜ë„ë¡ ë³€ê²½
    window.onload = async function () {
        setInitialTimeOption();
        await loadFishData();
    };
</script>
</body>
</html>