<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚šì‹œ ë„ê° - ë‘ê·¼ë‘ê·¼íƒ€ìš´</title>
    <link rel="stylesheet" href="../../css/common.css">
</head>
<body>
<div id="header-placeholder"></div>

<main>
    <div class="page-header">
        <h1>ğŸ£ ë‚šì‹œ ë„ê°</h1>
        <p>ë‘ê·¼ë‘ê·¼íƒ€ìš´ì˜ ëª¨ë“  ë¬¼ê³ ê¸° ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
    </div>

    <div class="stats" id="stats">
        <div class="stat-card">
            <div class="number">-</div>
            <div class="label">ì´ ë¬¼ê³ ê¸° ì¢…ë¥˜</div>
        </div>
        <div class="stat-card">
            <div class="number">-</div>
            <div class="label">ì„œì‹ì§€ ì¢…ë¥˜</div>
        </div>
        <div class="stat-card">
            <div class="number">-</div>
            <div class="label">ìµœê³  íŒë§¤ê°€</div>
        </div>
    </div>

    <div class="filter-section">
        <h2>ğŸ” í•„í„°</h2>

        <div class="search-box">
            <label for="fishSearch">ğŸŸ ë¬¼ê³ ê¸° ì´ë¦„ ê²€ìƒ‰</label>
            <input type="text" id="fishSearch" placeholder="ì˜ˆ: ì—°ì–´, ë°°ìŠ¤, ë¶•ì–´..." oninput="applyFilters()">
        </div>

        <div class="filter-groups">
            <div class="filter-group">
                <h3>â° ì¶œí˜„ ì‹œê°„</h3>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" value="ì•„ì¹¨" onchange="applyFilters()"> ì•„ì¹¨
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="ë‚®" onchange="applyFilters()"> ë‚®
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="ì €ë…" onchange="applyFilters()"> ì €ë…
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="ë°¤" onchange="applyFilters()"> ë°¤
                    </label>
                </div>
            </div>

            <div class="filter-group">
                <h3>â˜ï¸ ë‚ ì”¨ ì¡°ê±´</h3>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" value="ë§‘ìŒ" onchange="applyFilters()"> ë§‘ìŒ
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="ë¹„" onchange="applyFilters()"> ë¹„
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="ë¬´ì§€ê°œ" onchange="applyFilters()"> ë¬´ì§€ê°œ
                    </label>
                    <label class="checkbox-label" style="border-top: 1px solid #e9ecef; margin-top: 5px; padding-top: 10px;">
                        <input type="checkbox" id="rainbowOnly" onchange="applyFilters()"> ğŸŒˆ ë¬´ì§€ê°œì—ë§Œ ë“±ì¥
                    </label>
                </div>
            </div>

            <div class="filter-actions">
                <button onclick="selectAllTime()" class="filter-btn">ì‹œê°„ ì „ì²´ì„ íƒ</button>
                <button onclick="selectAllWeather()" class="filter-btn">ë‚ ì”¨ ì „ì²´ì„ íƒ</button>
                <button onclick="resetFilters()" class="filter-btn-reset">í•„í„° ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <div class="habitat-section" id="content">
        <div class="loading">ğŸŸ ë¬¼ê³ ê¸° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</main>

<div id="footer-placeholder"></div>

<script src="../../common.js"></script>

<script>
    let fishData = [];
    let currentSort = { column: 'name', order: 'asc' };

    async function loadFishData() {
        try {
            // ì—¬ëŸ¬ ê²½ë¡œ ì‹œë„
            let response = await fetch('fish_data.json');

            // ì²« ë²ˆì§¸ ì‹œë„ ì‹¤íŒ¨ ì‹œ ë‹¤ë¥¸ ê²½ë¡œ ì‹œë„
            if (!response.ok) {
                response = await fetch('./fish_data.json');
            }

            if (!response.ok) {
                throw new Error('fish_data.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            fishData = await response.json();
            console.log('ë¬¼ê³ ê¸° ë°ì´í„° ë¡œë“œ ì„±ê³µ:', fishData.length + 'ì¢…');
            displayStats();
            displayAllFish();
        } catch (error) {
            console.error('ë°ì´í„° ë¡œë“œ ì—ëŸ¬:', error);
            document.getElementById('content').innerHTML =
                `<div class="error">âŒ ë°ì´í„° íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><small>fish_data.json íŒŒì¼ì´ /src/pages/fish/ í´ë”ì— ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.<br>í˜„ì¬ ê²½ë¡œ: ${window.location.pathname}</small></div>`;
        }
    }

    function getSelectedFilters() {
        const timeCheckboxes = document.querySelectorAll('.filter-group:nth-child(1) input[type="checkbox"]:checked');
        const weatherCheckboxes = document.querySelectorAll('.filter-group:nth-child(2) input[type="checkbox"]:checked:not(#rainbowOnly)');
        const rainbowOnly = document.getElementById('rainbowOnly')?.checked || false;
        const searchText = document.getElementById('fishSearch')?.value.trim().toLowerCase() || '';

        return {
            times: Array.from(timeCheckboxes).map(cb => cb.value),
            weathers: Array.from(weatherCheckboxes).map(cb => cb.value),
            rainbowOnly: rainbowOnly,
            searchText: searchText
        };
    }

    function applyFilters() {
        displayAllFish();
    }

    function selectAllTime() {
        const checkboxes = document.querySelectorAll('.filter-group:nth-child(1) input[type="checkbox"]');
        checkboxes.forEach(cb => {
                if (!cb.id.includes('Only')) { // Only ë“¤ì–´ê°„ ê²ƒë§Œ ë¹¼ê³ 
                    cb.checked = true;
                }
            });
        applyFilters();
    }

    function selectAllWeather() {
        const checkboxes = document.querySelectorAll('.filter-group:nth-child(2) input[type="checkbox"]');
        checkboxes.forEach(cb => {
                if (!cb.id.includes('Only')) { // Only ë“¤ì–´ê°„ ê²ƒë§Œ ë¹¼ê³ 
                    cb.checked = true;
                }
            });
        applyFilters();
    }

    function resetFilters() {
        const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
        allCheckboxes.forEach(cb => cb.checked = false);
        applyFilters();
    }

    function displayStats() {
        const totalFish = fishData.length;
        const habitats = [...new Set(fishData.map(f => f.habitat))].length;
        const maxPrice = Math.max(...fishData.map(f => f.price));
        const statsHTML = `
            <div class="stat-card">
                <div class="number">${totalFish}</div>
                <div class="label">ì´ ë¬¼ê³ ê¸° ì¢…ë¥˜</div>
            </div>
            <div class="stat-card">
                <div class="number">${habitats}</div>
                <div class="label">ì„œì‹ì§€ ì¢…ë¥˜</div>
            </div>
            <div class="stat-card">
                <div class="number">â‚©${maxPrice}</div>
                <div class="label">ìµœê³  íŒë§¤ê°€</div>
            </div>
        `;
        document.getElementById('stats').innerHTML = statsHTML;
    }

    function sortFish(fishes, column, order) {
        return [...fishes].sort((a, b) => {
            let valueA, valueB;

            if (column === 'name' || column === 'habitat') {
                valueA = column === 'name' ? a.name : a.habitat;
                valueB = column === 'name' ? b.name : b.habitat;
                return order === 'asc' ? valueA.localeCompare(valueB, 'ko') : valueB.localeCompare(valueA, 'ko');
            } else if (column === 'level') {
                valueA = a.level;
                valueB = b.level;
            } else if (column === 'price') {
                valueA = a.price;
                valueB = b.price;
            }

            return order === 'asc' ? valueA - valueB : valueB - valueA;
        });
    }

    function handleSort(column) {
        if (currentSort.column === column) {
            currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.order = 'asc';
        }
        displayAllFish();
    }

    function displayAllFish() {
        const filters = getSelectedFilters();

        // í•„í„° ì ìš©
        let filteredFish = fishData;

        // ì´ë¦„ ê²€ìƒ‰ í•„í„°
        if (filters.searchText) {
            filteredFish = filteredFish.filter(fish => {
                return fish.name.toLowerCase().includes(filters.searchText);
            });
        }

        // ì‹œê°„ í•„í„°: ì„ íƒí•œ ì‹œê°„ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´ í‘œì‹œ (OR ì¡°ê±´)
        if (filters.times.length > 0) {
            filteredFish = filteredFish.filter(fish => {
                if (!fish.time || fish.time.length === 0) return false;
                return fish.time.some(t => filters.times.includes(t));
            });
        }

        // "ë¬´ì§€ê°œì—ë§Œ ë“±ì¥" í•„í„°
        if (filters.rainbowOnly) {
            filteredFish = filteredFish.filter(fish => {
                if (!fish.weather || fish.weather.length === 0) return false;
                // ë‚ ì”¨ê°€ ì •í™•íˆ ["ë¬´ì§€ê°œ"]ë§Œ ìˆëŠ” ë¬¼ê³ ê¸°
                return fish.weather.length === 1 && fish.weather[0] === "ë¬´ì§€ê°œ";
            });
        }
        // ì¼ë°˜ ë‚ ì”¨ í•„í„°: ì„ íƒí•œ ë‚ ì”¨ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´ í‘œì‹œ (OR ì¡°ê±´)
        else if (filters.weathers.length > 0) {
            filteredFish = filteredFish.filter(fish => {
                if (!fish.weather || fish.weather.length === 0) return false;
                return fish.weather.some(w => filters.weathers.includes(w));
            });
        }

        const sortedFish = sortFish(filteredFish, currentSort.column, currentSort.order);

        let html = `
            <div class="habitat-group">
                <div class="habitat-header">
                    <span>ì „ì²´ ë¬¼ê³ ê¸° ëª©ë¡</span>
                    <span class="count-badge">${sortedFish.length}ì¢…</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable ${currentSort.column === 'name' ? 'sort-' + currentSort.order : ''}"
                                    onclick="handleSort('name')">ì´ë¦„</th>
                                <th class="sortable ${currentSort.column === 'habitat' ? 'sort-' + currentSort.order : ''}"
                                    onclick="handleSort('habitat')">ì„œì‹ì§€</th>
                                <th class="sortable ${currentSort.column === 'level' ? 'sort-' + currentSort.order : ''}"
                                    onclick="handleSort('level')">ë ˆë²¨</th>
                                <th class="sortable ${currentSort.column === 'price' ? 'sort-' + currentSort.order : ''}"
                                    onclick="handleSort('price')">íŒë§¤ê°€</th>
                                <th>ì¶œí˜„ ì‹œê°„</th>
                                <th>ë‚ ì”¨ ì¡°ê±´</th>
                            </tr>
                        </thead>
                        <tbody>
        `;

        sortedFish.forEach(fish => {
            const timeDisplay = fish.timeAll ? 'í•˜ë£¨ ì¢…ì¼' : fish.time.map(t => `<span class="time-badge">${t}</span>`).join(' ');
            const weatherDisplay = fish.weatherAll ? 'í•­ìƒ' : fish.weather.map(w => `<span class="weather-badge">${w}</span>`).join(' ');

            html += `
                <tr>
                    <td class="fish-name">${fish.name}</td>
                    <td>${getHabitatIcon(fish.habitat)} ${fish.habitat}</td>
                    <td><span class="level-badge">Lv.${fish.level}</span></td>
                    <td class="price">â‚©${fish.price}</td>
                    <td>${timeDisplay}</td>
                    <td>${weatherDisplay}</td>
                </tr>
            `;
        });

        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        document.getElementById('content').innerHTML = html;
    }

    function getHabitatIcon(habitat) {
        const icons = {
            'ëª¨ë“  ê°•': 'ğŸŒŠ',
            'ì–•ì€ ê°•': 'ğŸ’§',
            'ë…¸ì„ê°•': 'ğŸŒ…',
            'ê³ ìš”í•œ ê°•': 'ğŸï¸',
            'ê±°ëª©ê°•': 'ğŸŒ³',
            'ëª¨ë“  í˜¸ìˆ˜': 'ğŸ’¦',
            'ê·¼êµ í˜¸ìˆ˜': 'ğŸ˜ï¸',
            'ì´ˆì› í˜¸ìˆ˜': 'ğŸŒ¾',
            'ì˜¨ì²œ ì‚°ìˆ˜': 'â™¨ï¸',
            'ìˆ²ì† í˜¸ìˆ˜': 'ğŸŒ²',
            'ëª¨ë“  ë°”ë‹¤': 'ğŸŒŠ',
            'êµ¬í•´': 'ğŸ–ï¸',
            'ë™í•´': 'ğŸš',
            'ì”ì”í•œ ë°”ë‹¤': 'ğŸŒ…',
            'ê³ ë˜ë°”ë‹¤': 'ğŸ‹',
            'ë°”ë‹¤ë‚šì‹œ': 'âš“'
        };
        return icons[habitat] || 'ğŸŸ';
    }

    window.onload = loadFishData;
</script>
</body>
</html>