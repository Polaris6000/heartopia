<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¼ê³ ê¸° ì°¾ê¸° - ë‘ê·¼ë‘ê·¼íƒ€ìš´</title>
    <link rel="stylesheet" href="../../css/common.css">
</head>
<body>
    <div id="header-placeholder"></div>

    <main>
        <div class="datetime-section">
            <h1>ğŸ” ë¬¼ê³ ê¸° ì°¾ê¸°</h1>
            <p>í˜„ì¬ ì¡°ê±´ì—ì„œ ì¡ì„ ìˆ˜ ìˆëŠ” ë¬¼ê³ ê¸°ë¥¼ ì°¾ì•„ë³´ì„¸ìš”</p>

            <div class="datetime-display">
                <div class="date-info">
                    <div class="current-date" id="currentDate"></div>
                    <div class="current-time" id="currentTime"></div>
                </div>
            </div>
            <div class="time-bar">
                <div class="time-segment morning">
                    <div class="segment-label">ğŸŒ… ì•„ì¹¨</div>
                    <div class="segment-time">06:00 - 12:00</div>
                </div>
                <div class="time-segment afternoon">
                    <div class="segment-label">â˜€ï¸ ë‚®</div>
                    <div class="segment-time">12:00 - 18:00</div>
                </div>
                <div class="time-segment evening">
                    <div class="segment-label">ğŸŒ† ì €ë…</div>
                    <div class="segment-time">18:00 - 00:00</div>
                </div>
                <div class="time-segment night">
                    <div class="segment-label">ğŸŒ™ ë°¤</div>
                    <div class="segment-time">00:00 - 06:00</div>
                </div>
                <div class="time-indicator" id="timeIndicator"></div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-group">
                <div class="input-item">
                    <label for="fishName">ğŸŸ ë¬¼ê³ ê¸° ì´ë¦„</label>
                    <input type="text" id="fishName" placeholder="ì˜ˆ: ë°°ìŠ¤, ì—°ì–´, ë¶•ì–´" oninput="filterFish()">
                </div>

                <div class="input-item">
                    <label for="level">ğŸ£ ë‚šì‹œ ë ˆë²¨</label>
                    <input type="number" id="level" min="1" max="20" value="5">
                </div>

                <div class="input-item">
                    <label for="time">ğŸ• ì‹œê°„ëŒ€</label>
                    <select id="time">
                        <option value="ì•„ì¹¨">ì•„ì¹¨</option>
                        <option value="ë‚®">ë‚®</option>
                        <option value="ì €ë…">ì €ë…</option>
                        <option value="ë°¤" selected>ë°¤</option>
                    </select>
                </div>

                <div class="input-item">
                    <label for="weather">ğŸŒ¤ï¸ ë‚ ì”¨</label>
                    <select id="weather">
                        <option value="ë§‘ìŒ" selected>ë§‘ìŒ</option>
                        <option value="ë¹„">ë¹„</option>
                        <option value="ë¬´ì§€ê°œ">ë¬´ì§€ê°œ</option>
                    </select>
                </div>
            </div>

            <button onclick="filterFish()">ğŸ” ë¬¼ê³ ê¸° ì°¾ê¸°</button>
        </div>

        <div id="results" class="results"></div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="../../common.js"></script>
    <script>
        let fishData = [];
        let currentSort = { column: 'name', order: 'asc' };

        function updateDateTime() {
            const now = new Date();
            const days = ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const date = String(now.getDate()).padStart(2, '0');
            const dayName = days[now.getDay()];
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            document.getElementById('currentDate').textContent =
                `${year}ë…„ ${month}ì›” ${date}ì¼ ${dayName}`;
            document.getElementById('currentTime').textContent =
                `${hours}:${minutes}:${seconds}`;

            // í˜„ì¬ ì‹œê°„ëŒ€ ê³„ì‚° ë° í™œì„±í™”
            const hour = now.getHours();
            let currentPeriod = '';
            let position = 0;

            if (hour >= 6 && hour < 12) {
                currentPeriod = 'morning';
                position = ((hour - 6) * 60 + now.getMinutes()) / 360;
                position = position * 25 + 12.5;
            } else if (hour >= 12 && hour < 18) {
                currentPeriod = 'afternoon';
                position = ((hour - 12) * 60 + now.getMinutes()) / 360;
                position = position * 25 + 37.5;
            } else if (hour >= 18 && hour < 24) {
                currentPeriod = 'evening';
                position = ((hour - 18) * 60 + now.getMinutes()) / 360;
                position = position * 25 + 62.5;
            } else {
                currentPeriod = 'night';
                position = (hour * 60 + now.getMinutes()) / 360;
                position = position * 25 + 87.5;
            }

            // ëª¨ë“  ì„¸ê·¸ë¨¼íŠ¸ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.time-segment').forEach(seg => {
                seg.classList.remove('active');
            });

            // í˜„ì¬ ì‹œê°„ëŒ€ì— active í´ë˜ìŠ¤ ì¶”ê°€
            const activeSegment = document.querySelector(`.time-segment.${currentPeriod}`);
            if (activeSegment) {
                activeSegment.classList.add('active');
            }

            // ì¸ë””ì¼€ì´í„° ìœ„ì¹˜ ì„¤ì •
            const indicator = document.getElementById('timeIndicator');
            indicator.style.left = `calc(${position}% - 12px)`;
        }

        // 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
        setInterval(updateDateTime, 1000);
        updateDateTime();

        async function loadFishData() {
            try {
                const response = await fetch('fish_data.json');
                if (!response.ok) throw new Error('fish_data.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                fishData = await response.json();
                filterFish();
            } catch (error) {
                document.getElementById('results').innerHTML =
                    `<div class="error">âŒ ë°ì´í„° íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><small>fish_data.json íŒŒì¼ì´ ê°™ì€ í´ë”ì— ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</small></div>`;
            }
        }

        function filterFish() {
            if (fishData.length === 0) {
                document.getElementById('results').innerHTML = '<div class="loading">â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
                return;
            }

            const fishName = document.getElementById('fishName').value.trim().toLowerCase();
            const level = parseInt(document.getElementById('level').value);
            const time = document.getElementById('time').value;
            const weather = document.getElementById('weather').value;

            const filtered = fishData.filter(fish => {
                if (fishName && !fish.name.toLowerCase().includes(fishName)) return false;
                if (fish.level > level) return false;
                const timeOk = fish.time && fish.time.includes(time);
                const weatherOk = fish.weather && fish.weather.includes(weather);
                return timeOk && weatherOk;
            });

            displayResults(filtered);
        }

        function sortFish(fishes, column, order) {
            return [...fishes].sort((a, b) => {
                let valueA, valueB;
                if (column === 'name' || column === 'habitat') {
                    valueA = column === 'name' ? a.name : a.habitat;
                    valueB = column === 'name' ? b.name : b.habitat;
                    return order === 'asc' ? valueA.localeCompare(valueB, 'ko') : valueB.localeCompare(valueA, 'ko');
                } else if (column === 'level') {
                    valueA = a.level;
                    valueB = b.level;
                } else if (column === 'price') {
                    valueA = a.price;
                    valueB = b.price;
                }
                return order === 'asc' ? valueA - valueB : valueB - valueA;
            });
        }

        function handleSort(column) {
            if (currentSort.column === column) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.order = 'asc';
            }
            filterFish();
        }

        function displayResults(fishes) {
            const resultsDiv = document.getElementById('results');

            if (fishes.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">âš ï¸ í˜„ì¬ ì¡°ê±´ì—ì„œ ì¡ì„ ìˆ˜ ìˆëŠ” ë¬¼ê³ ê¸°ê°€ ì—†ì–´ìš”!</div>';
                return;
            }

            const sortedFishes = sortFish(fishes, currentSort.column, currentSort.order);

            let html = `
                <div class="habitat-group">
                    <div class="habitat-header">
                        <span>ê²€ìƒ‰ ê²°ê³¼</span>
                        <span class="count-badge">${sortedFishes.length} ì¢…</span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="sortable ${currentSort.column === 'name' ? 'sort-' + currentSort.order : ''}" onclick="handleSort('name')">ì´ë¦„</th>
                                    <th class="sortable ${currentSort.column === 'habitat' ? 'sort-' + currentSort.order : ''}" onclick="handleSort('habitat')">ì„œì‹ì§€</th>
                                    <th class="sortable ${currentSort.column === 'level' ? 'sort-' + currentSort.order : ''}" onclick="handleSort('level')">ë ˆë²¨</th>
                                    <th class="sortable ${currentSort.column === 'price' ? 'sort-' + currentSort.order : ''}" onclick="handleSort('price')">íŒë§¤ê°€</th>
                                    <th>ì¶œí˜„ ì‹œê°„</th>
                                    <th>ë‚ ì”¨ ì¡°ê±´</th>
                                </tr>
                            </thead>
                            <tbody>`;

            sortedFishes.forEach(fish => {
                const timeDisplay = fish.time ? fish.time.map(t => `<span class="time-badge">${t}</span>`).join(' ') : '-';
                const weatherDisplay = fish.weather ? fish.weather.map(w => `<span class="weather-badge">${w}</span>`).join(' ') : '-';

                html += `
                    <tr>
                        <td class="fish-name">${fish.name}</td>
                        <td>${fish.habitat}</td>
                        <td><span class="level-badge">Lv.${fish.level}</span></td>
                        <td class="price">â‚©${fish.price}</td>
                        <td>${timeDisplay}</td>
                        <td>${weatherDisplay}</td>
                    </tr>`;
            });

            html += `</tbody></table></div></div>`;
            resultsDiv.innerHTML = html;
        }

        window.onload = loadFishData;
    </script>
</body>
</html>