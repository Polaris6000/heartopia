<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>ì‘ë¬¼ ë„ê° - ë‘ê·¼ë‘ê·¼íƒ€ìš´</title>
    <link href="../../css/common.css" rel="stylesheet">
    <style>
        /* â”€â”€ ì‘ë¬¼ ë„ê° ì „ìš© ì»¬ëŸ¼ ë„ˆë¹„ â”€â”€ */
        .col-seed    { width: 140px; min-width: 140px; }
        .col-harvest { width: 120px; min-width: 140px; }
        .col-profit  { width: 180px; min-width: 180px; }

        /* ì´ìœ¤ ì…€ ì»¬ëŸ¬ */
        .profit-positive { color: #4caf50; font-weight: 600; }
        .profit-negative { color: #e53935; font-weight: 600; }

        /* ë¹™ì„¤ ì‹œì¦Œ ì‘ë¬¼ ë±ƒì§€ */
        .season-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            font-size: 0.78em;
            padding: 2px 7px;
            border-radius: 8px;
            margin-left: 4px;
            font-weight: 600;
        }

        /* ìˆ˜í™• ì‹œê°„ ë±ƒì§€ */
        .harvest-badge {
            display: inline-block;
            background: var(--color-surface-light);
            color: var(--color-text-soft);
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 0.9em;
        }

        /* í•„í„° ì„¹ì…˜: ê²€ìƒ‰ì°½ + ë²„íŠ¼ ìˆ˜í‰ ë°°ì¹˜ */
        .crops-filter-row {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        /* ê²€ìƒ‰ì°½ì´ ë‚¨ì€ ê³µê°„ ì±„ìš°ë„ë¡ */
        .crops-filter-row .search-box {
            flex: 1;
            margin-bottom: 0;   /* ê¸°ë³¸ margin-bottom ì œê±° */
        }

        /* ë²„íŠ¼ ë¬¶ìŒì€ ì„¸ë¡œ ë°©í–¥ ìœ ì§€, ë„ˆë¹„ ê³ ì • */
        .crops-filter-row .filter-actions {
            flex-direction: column;
            flex-shrink: 0;
            min-width: 160px;
        }

        /* â”€â”€ ì‘ë¬¼ ì´ë¯¸ì§€ ì¸ë„¤ì¼ â”€â”€ */
        .col-img { width: 60px; min-width: 60px; text-align: center; }

        .crop-img {
            width: 44px;
            height: 44px;
            object-fit: contain;
            image-rendering: pixelated; /* í”½ì…€ ì•„íŠ¸ ìŠ¤íƒ€ì¼ ì„ ëª…í•˜ê²Œ */
            vertical-align: middle;
        }

        /* ì´ë¯¸ì§€ ì—†ëŠ” ê²½ìš° ë¹ˆ ì…€ ìë¦¬ ìœ ì§€ */
        .crop-img-placeholder {
            display: inline-block;
            width: 44px;
            height: 44px;
        }
</style>
</head>
<body>
<div id="header-placeholder"></div>

<main>
    <!-- â”€â”€ í˜ì´ì§€ í—¤ë” â”€â”€ -->
    <div class="page-header">
        <h1>ğŸŒ± ì‘ë¬¼ ë„ê°</h1>
        <p>ë‘ê·¼ë‘ê·¼íƒ€ìš´ì˜ ëª¨ë“  ì‘ë¬¼ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
    </div>

    <!-- â”€â”€ í†µê³„ ì¹´ë“œ â”€â”€ -->
    <div class="stats" id="stats">
        <div class="stat-card">
            <div class="number">-</div>
            <div class="label">ì´ ì‘ë¬¼ ì¢…ë¥˜</div>
        </div>
        <div class="stat-card">
            <div class="number">-</div>
            <div class="label">ìµœë‹¨ ìˆ˜í™• ì‹œê°„</div>
        </div>
        <div class="stat-card">
            <div class="number">-</div>
            <div class="label">ìµœê³  íŒë§¤ê°€ (1ì„±)</div>
        </div>
        <div class="stat-card">
            <div class="number">-</div>
            <div class="label">ìµœëŒ€ ì´ìœ¤ (1ì„±)</div>
        </div>
    </div>

    <!-- â”€â”€ í•„í„° ì„¹ì…˜ â”€â”€ -->
    <div class="filter-section">
        <h2>ğŸ” í•„í„°</h2>

        <!-- ê²€ìƒ‰ì°½ + ë²„íŠ¼ ìˆ˜í‰ ë°°ì¹˜ -->
        <div class="crops-filter-row">

            <!-- ì´ë¦„ ê²€ìƒ‰ -->
            <div class="search-box">
                <label for="cropSearch">ğŸŒ¿ ì‘ë¬¼ ì´ë¦„ ê²€ìƒ‰</label>
                <input id="cropSearch" oninput="applyFilters()" placeholder="ì˜ˆ: í† ë§ˆí† , ë°€, ë”¸ê¸°..." type="text">
            </div>

            <!-- ì‹œì¦Œ Â· ì´ˆê¸°í™” ë²„íŠ¼ -->
            <div class="filter-actions">
                <button class="filter-btn season-ice-btn" onclick="loadSeasonData()">â„ï¸ ë¹™ì„¤ ì‹œì¦Œ ì¶”ê°€</button>
                <button class="filter-btn-reset season-ice-btn" onclick="removeSeasonData()">ğŸ—‘ï¸ ì‹œì¦Œ ë°ì´í„° ì œê±°</button>
                <button class="filter-btn-reset" onclick="resetFilters()">í•„í„° ì´ˆê¸°í™”</button>
            </div>

        </div>
    </div>

    <!-- â”€â”€ í…Œì´ë¸” ì˜ì—­ â”€â”€ -->
    <div class="habitat-section" id="content">
        <div class="loading">ğŸŒ± ì‘ë¬¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</main>

<div id="footer-placeholder"></div>

<script src="../../js/common.js"></script>
<script>
    /* ========================================================
       ì‘ë¬¼ ì´ë¯¸ì§€ ë§¤í•‘ (í•œê¸€ ì´ë¦„ â†’ ìƒëŒ€ ê²½ë¡œ)
       í˜ì´ì§€ ìœ„ì¹˜: /src/pages/crops/  â†’  ../../../public/images/crop/
    ======================================================== */
    const CROP_IMAGES = {
        'í† ë§ˆí† ':   '../../../public/images/crop/spr_ui_item_normal_p_cropaward_tomato_award.png',
        'ê°ì':     '../../../public/images/crop/spr_ui_item_normal_p_cropaward_potato_award.png',
        'ë°€':       '../../../public/images/crop/spr_ui_item_normal_p_cropaward_wheat_award.png',
        'ì–‘ìƒì¶”':   '../../../public/images/crop/spr_ui_item_normal_p_cropaward_lettuce_award.png',
        'íŒŒì¸ì• í”Œ': '../../../public/images/crop/spr_ui_item_normal_p_cropaward_pineapple_award.png',
        'ë‹¹ê·¼':     '../../../public/images/crop/spr_ui_item_normal_p_cropaward_carrot_award.png',
        'ë”¸ê¸°':     '../../../public/images/crop/spr_ui_item_normal_p_cropaward_strawberry_award.png',
        'ì˜¥ìˆ˜ìˆ˜':   '../../../public/images/crop/spr_ui_item_normal_p_cropaward_corn_award.png',
        'í¬ë„':     '../../../public/images/crop/spr_ui_item_normal_p_cropaward_grape_award.png',
        'ê°€ì§€':     '../../../public/images/crop/spr_ui_item_normal_p_cropaward_eggplant.png',
        'ë¬´':       '../../../public/images/crop/spr_ui_item_normal_p_cropaward_whiteradish.png',
    };

    /* ========================================================
       ìƒíƒœ ë³€ìˆ˜
    ======================================================== */
    let cropsData   = [];       // í˜„ì¬ í™”ë©´ì— í‘œì‹œ ì¤‘ì¸ ë°ì´í„°
    let baseData    = [];       // ì›ë³¸ ë°ì´í„° (ì‹œì¦Œ ì œê±° ì‹œ ë³µì›ìš©)
    let gradeMultipliers = {};  // crops.jsonì—ì„œ ì½ì–´ì˜¨ ì„±ê¸‰ ë°°ìœ¨
    let iceLoaded   = false;    // ë¹™ì„¤ ì‹œì¦Œ ë°ì´í„° ë¡œë“œ ì—¬ë¶€
    let currentSort = { column: 'sellPrice', order: 'desc' };


    /* ========================================================
       ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    ======================================================== */
    async function loadCropsData() {
        try {
            const response = await fetch('../../data/crops.json');
            if (!response.ok) throw new Error('crops.jsonì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

            const json = await response.json();
            gradeMultipliers = json.gradeMultipliers; // ë°°ìœ¨ ì €ì¥
            baseData   = json.items;
            cropsData  = [...baseData];

            displayStats();
            displayAllCrops();
        } catch (error) {
            console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            document.getElementById('content').innerHTML =
                `<div class="error">âŒ ë°ì´í„° íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
        }
    }


    /* ========================================================
       ë¹™ì„¤ ì‹œì¦Œ ë°ì´í„° ì¶”ê°€ / ì œê±°
    ======================================================== */
    async function loadSeasonData() {
        if (iceLoaded) { alert('ì´ë¯¸ ë¹™ì„¤ ì‹œì¦Œ ë°ì´í„°ê°€ ì¶”ê°€ë˜ì–´ ìˆìŠµë‹ˆë‹¤.'); return; }

        try {
            const response = await fetch('../../data/season_ice/season_ice_crops.json');
            if (!response.ok) throw new Error('season_ice_crops.jsonì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

            const json = await response.json();
            const seasonItems = json.items.map(item => ({ ...item, isSeason: true })); // ì‹œì¦Œ í”Œë˜ê·¸ ì¶”ê°€

            // ì´ë¦„ ê¸°ì¤€ ì¤‘ë³µ ì œê±° í›„ ë³‘í•©
            const combined = [...cropsData, ...seasonItems];
            cropsData = combined.filter((item, idx, self) =>
                idx === self.findIndex(c => c.name === item.name)
            );

            iceLoaded = true;
            alert(`â„ï¸ ë¹™ì„¤ ì‹œì¦Œ ì‘ë¬¼ ${seasonItems.length}ì¢…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ ${cropsData.length}ì¢…)`);
            displayStats();
            displayAllCrops();
        } catch (error) {
            console.error('ì‹œì¦Œ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            alert(`ì‹œì¦Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n${error.message}`);
        }
    }

    async function removeSeasonData() {
        if (!iceLoaded) { alert('ì œê±°í•  ì‹œì¦Œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

        cropsData = [...baseData];
        iceLoaded = false;
        alert('ë¹™ì„¤ ì‹œì¦Œ ë°ì´í„°ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
        displayStats();
        displayAllCrops();
    }


    /* ========================================================
       í•„í„° / ê²€ìƒ‰
    ======================================================== */
    function getSearchText() {
        return document.getElementById('cropSearch')?.value.trim().toLowerCase() || '';
    }

    function applyFilters() { displayAllCrops(); }

    function resetFilters() {
        document.getElementById('cropSearch').value = '';
        applyFilters();
    }


    /* ========================================================
       ì •ë ¬
    ======================================================== */
    function handleSort(column) {
        if (currentSort.column === column) {
            currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.order = 'asc';
        }
        displayAllCrops();
    }

    function sortCrops(list, column, order) {
        return [...list].sort((a, b) => {
            let va, vb;
            if (column === 'name') {
                return order === 'asc'
                    ? a.name.localeCompare(b.name, 'ko')
                    : b.name.localeCompare(a.name, 'ko');
            }
            if (column === 'profit') {
                va = a.sellPrice - a.seedPrice;
                vb = b.sellPrice - b.seedPrice;
            } else if (column === 'profitPerHour') {
                // ì‹œê°„ ëŒ€ë¹„ ì´ìœ¤: ì´ìœ¤ Ã· ìˆ˜í™• ì‹œê°„(ì‹œê°„ ë‹¨ìœ„)
                va = (a.sellPrice - a.seedPrice) / (a.harvestMinutes / 60);
                vb = (b.sellPrice - b.seedPrice) / (b.harvestMinutes / 60);
            } else {
                va = a[column];
                vb = b[column];
            }
            return order === 'asc' ? va - vb : vb - va;
        });
    }


    /* ========================================================
       í†µê³„ ì¹´ë“œ ë Œë”ë§
    ======================================================== */
    function displayStats() {
        const total    = cropsData.length;
        const minTime  = Math.min(...cropsData.map(c => c.harvestMinutes));
        const maxSell  = Math.max(...cropsData.map(c => c.sellPrice));
        const maxProfit = Math.max(...cropsData.map(c => c.sellPrice - c.seedPrice));

        document.getElementById('stats').innerHTML = `
            <div class="stat-card">
                <div class="number">${total}</div>
                <div class="label">ì´ ì‘ë¬¼ ì¢…ë¥˜</div>
            </div>
            <div class="stat-card">
                <div class="number">${formatMinutes(minTime)}</div>
                <div class="label">ìµœë‹¨ ìˆ˜í™• ì‹œê°„</div>
            </div>
            <div class="stat-card">
                <div class="number">â‚©${maxSell.toLocaleString()}</div>
                <div class="label">ìµœê³  íŒë§¤ê°€ (1ì„±)</div>
            </div>
            <div class="stat-card">
                <div class="number">â‚©${maxProfit.toLocaleString()}</div>
                <div class="label">ìµœëŒ€ ì´ìœ¤ (1ì„±)</div>
            </div>
        `;
    }


    /* ========================================================
       í…Œì´ë¸” ë Œë”ë§
    ======================================================== */
    function displayAllCrops() {
        const searchText = getSearchText();

        // ê²€ìƒ‰ í•„í„°
        let filtered = cropsData.filter(c =>
            !searchText || c.name.toLowerCase().includes(searchText)
        );

        const sorted = sortCrops(filtered, currentSort.column, currentSort.order);

        // ì •ë ¬ í—¤ë” í´ë˜ìŠ¤ í—¬í¼
        const sc = (col) =>
            `sortable ${currentSort.column === col ? 'sort-' + currentSort.order : ''}`;

        let html = `
            <div class="habitat-group">
                <div class="habitat-header">
                    <span>ğŸŒ± ì „ì²´ ì‘ë¬¼ ëª©ë¡</span>
                    <span class="count-badge">${sorted.length}ì¢…</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="col-img"></th>
                                <th class="${sc('name')}"             onclick="handleSort('name')">ì´ë¦„</th>
                                <th class="${sc('seedPrice')} col-seed"    onclick="handleSort('seedPrice')">ì”¨ì•— ê°€ê²©</th>
                                <th class="${sc('harvestMinutes')} col-harvest" onclick="handleSort('harvestMinutes')">ìˆ˜í™• ì‹œê°„</th>
                                <th class="${sc('sellPrice')}"        onclick="handleSort('sellPrice')">íŒë§¤ê°€</th>
                                <th class="${sc('profit')} col-profit"     onclick="handleSort('profit')">ì´ìœ¤</th>
                                <th class="${sc('profitPerHour')} col-profit" onclick="handleSort('profitPerHour')">ì‹œê°„ ëŒ€ë¹„ ì´ìœ¤</th>
                            </tr>
                        </thead>
                        <tbody>
        `;

        sorted.forEach(crop => {
            const seasonTag = crop.isSeason
                ? '<span class="season-badge">â„ï¸ ë¹™ì„¤</span>'
                : '';

            // 1ì„± ê¸°ì¤€ ì´ìœ¤ Â· ì‹œê°„ ëŒ€ë¹„ ì´ìœ¤
            const baseProfit      = crop.sellPrice - crop.seedPrice;
            const profitClass     = baseProfit >= 0 ? 'profit-positive' : 'profit-negative';
            const profitSign      = baseProfit >= 0 ? '+' : '';
            const profitPerHour   = baseProfit / (crop.harvestMinutes / 60);
            const pphSign         = profitPerHour >= 0 ? '+' : '';
            const pphClass        = profitPerHour >= 0 ? 'profit-positive' : 'profit-negative';

            // ì´ë¯¸ì§€ íƒœê·¸ ìƒì„± (ì—†ìœ¼ë©´ ë¹ˆ placeholder)
            const imgSrc = CROP_IMAGES[crop.name];
            const imgTag = imgSrc
                ? `<img class="crop-img" src="${imgSrc}" alt="${crop.name}">`
                : `<span class="crop-img-placeholder"></span>`;

            html += `
            <tr>
                <td class="col-img">${imgTag}</td>
                <td class="item-name">${crop.name}${seasonTag}</td>
                <td>â‚©${crop.seedPrice.toLocaleString()}</td>
                <td><span class="harvest-badge">â± ${formatMinutes(crop.harvestMinutes)}</span></td>
                <td>
                    <div class="price-cell">
                        <span>â­</span>
                        <select class="star-selector"
                                onchange="updatePrice(${crop.sellPrice}, ${crop.seedPrice}, ${crop.harvestMinutes}, this)">
                            ${[1,2,3,4,5].map(s =>
                                `<option value="${s}">${s}ì„±</option>`
                            ).join('')}
                        </select>
                        <span class="price">â‚©${crop.sellPrice.toLocaleString()}</span>
                    </div>
                </td>
                <td class="${profitClass}">${profitSign}â‚©${baseProfit.toLocaleString()}</td>
                <td class="${pphClass}">${pphSign}â‚©${Math.round(profitPerHour).toLocaleString()}/ì‹œê°„</td>
            </tr>`;
        });

        html += `
                        </tbody>
                    </table>
                </div>
            </div>`;

        if (sorted.length === 0) {
            html = `<div class="no-results">ğŸŒ¿ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        }

        document.getElementById('content').innerHTML = html;
    }


    /* ========================================================
       ì„±ê¸‰ ì„ íƒ ì‹œ íŒë§¤ê°€Â·ì´ìœ¤ ê°±ì‹ 
    ======================================================== */
    function updatePrice(baseSellPrice, seedPrice, harvestMinutes, selectEl) {
        const star         = parseInt(selectEl.value);
        const multiplier   = gradeMultipliers[star] ?? 1;
        const adjusted     = Math.floor(baseSellPrice * multiplier);
        const profit       = adjusted - seedPrice;
        const profitSign   = profit >= 0 ? '+' : '';
        const profitPerHour = profit / (harvestMinutes / 60);
        const pphSign      = profitPerHour >= 0 ? '+' : '';

        const row = selectEl.closest('tr');
        const tds = row.querySelectorAll('td');

        // íŒë§¤ê°€ ì—…ë°ì´íŠ¸
        row.querySelector('.price').textContent = `â‚©${adjusted.toLocaleString()}`;

        // ì´ìœ¤ ì…€ ì—…ë°ì´íŠ¸ (td[5]: ì´ë¯¸ì§€ ì»¬ëŸ¼ ì¶”ê°€ë¡œ 1ì¹¸ ë°€ë¦¼)
        tds[5].textContent = `${profitSign}â‚©${profit.toLocaleString()}`;
        tds[5].className   = profit >= 0 ? 'profit-positive' : 'profit-negative';

        // ì‹œê°„ ëŒ€ë¹„ ì´ìœ¤ ì…€ ì—…ë°ì´íŠ¸ (td[6])
        tds[6].textContent = `${pphSign}â‚©${Math.round(profitPerHour).toLocaleString()}/ì‹œê°„`;
        tds[6].className   = profitPerHour >= 0 ? 'profit-positive' : 'profit-negative';
    }


    /* ========================================================
       ìœ í‹¸ - ë¶„ â†’ ì‹œê°„ í‘œì‹œ ë³€í™˜
    ======================================================== */
    function formatMinutes(minutes) {
        if (minutes < 60) return `${minutes}ë¶„`;
        const h = Math.floor(minutes / 60);
        const m = minutes % 60;
        return m === 0 ? `${h}ì‹œê°„` : `${h}ì‹œê°„ ${m}ë¶„`;
    }


    /* ========================================================
       í˜ì´ì§€ ì´ˆê¸°í™”
    ======================================================== */
    window.onload = loadCropsData;
</script>
</body>
</html>
